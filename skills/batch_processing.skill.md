# Batch Processing Skill (分批處理)

## 🎯 適用場景
當輸入內容超過 token 限制時，分批處理

## 📏 分批規則

### 字數閾值
| 總字數 | 處理方式 |
|--------|----------|
| < 10,000 | 直接處理 |
| 10,000 - 50,000 | 分 2-5 批 |
| 50,000 - 100,000 | 分 5-10 批 |
| > 100,000 | 分 10+ 批 |

### 分批公式
```
批次數 = Math.ceil(總字數 / 10000)
每批字數 = 10000 字
```

## 🔄 分批處理流程

### 第一批（識別結構）
```
輸入：前 10000 字
任務：識別場景標記格式、主要角色、整體風格
輸出：結構摘要
```

### 中間批次（累積分析）
```
輸入：第 N 批 10000 字 + 前批摘要
任務：繼續識別場景、記錄關鍵情節點
輸出：更新摘要
```

### 最後批次（總結合併）
```
輸入：最後 10000 字 + 完整摘要
任務：確定結局、生成最終分集方案
輸出：完整 episodes JSON
```

## 📤 輸出格式

每批返回：
```json
{
  "batch": 1,
  "total_batches": 5,
  "scenes_found": ["場景1", "場景2", ...],
  "characters_found": ["角色1", "角色2"],
  "key_events": ["事件1", "事件2"],
  "partial_structure": {
    "act1_scenes": [1, 5],
    "act2_scenes": [6, 15],
    "act3_scenes": [16, 20]
  }
}
```

最終返回：
```json
{
  "total_episodes": 6,
  "episodes": [...],
  "characters": [...],
  "summary": {...}
}
```

## 💡 優化技巧

1. **重疊讀取**：每批末尾 500 字與下批開頭重疊，避免斷句
2. **增量更新**：每批只輸出新發現的內容
3. **關鍵標記**：優先識別場景標記，減少無效內容
